name: rdp with mehraz

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP
        run: |
          Write-Host "Configuring RDP settings..."
          
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          
          # Disable Network Level Authentication for easier access
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          
          # Set Security Layer to RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force
          
          # Configure firewall rules
          Write-Host "Configuring firewall..."
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          
          # Remove any existing custom rule
          netsh advfirewall firewall delete rule name="mehraz-Tailscale" 2>$null
          
          # Add new firewall rule for RDP
          netsh advfirewall firewall add rule name="mehraz-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389
          
          # Restart Remote Desktop service
          Write-Host "Restarting Terminal Service..."
          Restart-Service -Name TermService -Force
          Start-Sleep -Seconds 3
          
          Write-Host "RDP configuration completed successfully"

      - name: Create RDP User with Fixed Password
        shell: powershell
        run: |
          Write-Host "Creating user account..."
          
          # Strong password that meets Windows Server requirements
          $password = "M3hr@z!2024#Secure"
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Remove user if exists
          try {
              Remove-LocalUser -Name "mehraz" -ErrorAction SilentlyContinue
              Write-Host "Removed existing user"
          } catch {
              Write-Host "No existing user to remove"
          }
          
          # Create new local user
          try {
              New-LocalUser -Name "mehraz" `
                           -Password $securePassword `
                           -FullName "Mehraz User" `
                           -Description "RDP User Account" `
                           -PasswordNeverExpires `
                           -AccountNeverExpires `
                           -ErrorAction Stop
              
              Write-Host "User 'mehraz' created successfully"
          } catch {
              Write-Error "Failed to create user: $_"
              exit 1
          }
          
          # Add to Administrators group
          try {
              Add-LocalGroupMember -Group "Administrators" -Member "mehraz" -ErrorAction Stop
              Write-Host "Added to Administrators group"
          } catch {
              Write-Warning "Could not add to Administrators: $_"
          }
          
          # Add to Remote Desktop Users group
          try {
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "mehraz" -ErrorAction Stop
              Write-Host "Added to Remote Desktop Users group"
          } catch {
              Write-Warning "Could not add to Remote Desktop Users: $_"
          }
          
          # Enable the user account
          Enable-LocalUser -Name "mehraz"
          
          # Save password to GitHub env
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          # Display user info
          Write-Host "`nUser configuration:"
          Get-LocalUser -Name "mehraz" | Format-List Name, Enabled, Description
          
          Write-Host "`nPassword: $password"

      - name: Verify User Creation
        run: |
          Write-Host "Verifying user creation..."
          
          # Check if user exists
          $user = Get-LocalUser -Name "mehraz" -ErrorAction SilentlyContinue
          if ($user) {
              Write-Host "✓ User 'mehraz' exists"
              Write-Host "  Enabled: $($user.Enabled)"
              Write-Host "  Full Name: $($user.FullName)"
              
              # Check group memberships
              Write-Host "`nChecking group memberships:"
              
              $isAdmin = Get-LocalGroupMember -Group "Administrators" -ErrorAction SilentlyContinue | 
                         Where-Object { $_.Name -like "*mehraz" }
              if ($isAdmin) {
                  Write-Host "✓ User is in Administrators group"
              } else {
                  Write-Warning "User is NOT in Administrators group"
              }
              
              $isRdpUser = Get-LocalGroupMember -Group "Remote Desktop Users" -ErrorAction SilentlyContinue | 
                           Where-Object { $_.Name -like "*mehraz" }
              if ($isRdpUser) {
                  Write-Host "✓ User is in Remote Desktop Users group"
              } else {
                  Write-Warning "User is NOT in Remote Desktop Users group"
              }
          } else {
              Write-Error "User creation verification failed"
              exit 1
          }

      - name: Install Tailscale
        run: |
          Write-Host "Installing Tailscale..."
          
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          # Download Tailscale installer
          Write-Host "Downloading Tailscale installer..."
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing
          
          # Install Tailscale
          Write-Host "Running Tailscale installer..."
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -NoNewWindow
          
          # Clean up installer
          Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
          
          # Wait for installation to complete
          Start-Sleep -Seconds 5
          
          # Verify installation
          if (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe") {
              Write-Host "✓ Tailscale installed successfully"
          } else {
              Write-Error "Tailscale installation failed"
              exit 1
          }

      - name: Establish Tailscale Connection
        run: |
          Write-Host "Connecting to Tailscale network..."
          
          # Set Tailscale path
          $tailscale = "$env:ProgramFiles\Tailscale\tailscale.exe"
          
          # Authenticate and connect
          Write-Host "Authenticating with Tailscale..."
          & $tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
                          --hostname=gh-runner-$env:GITHUB_RUN_ID `
                          --accept-routes `
                          --accept-dns=false
          
          # Wait for IP assignment
          Write-Host "Waiting for Tailscale IP assignment..."
          $tsIP = $null
          $retries = 0
          $maxRetries = 20
          
          while (-not $tsIP -and $retries -lt $maxRetries) {
              Start-Sleep -Seconds 3
              $tsIP = & $tailscale ip -4 2>$null
              $tsIP = $tsIP | Where-Object { $_ -match '\d+\.\d+\.\d+\.\d+' } | Select-Object -First 1
              $retries++
              Write-Host "Attempt $retries of $maxRetries..."
          }
          
          if (-not $tsIP) {
              Write-Error "Failed to get Tailscale IP after $maxRetries attempts"
              & $tailscale status
              exit 1
          }
          
          Write-Host "✓ Tailscale connected successfully"
          Write-Host "Tailscale IP: $tsIP"
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          
          # Show Tailscale status
          Write-Host "`nTailscale Status:"
          & $tailscale status

      - name: Verify RDP Accessibility
        run: |
          Write-Host "Verifying RDP accessibility..."
          
          # Check if RDP service is running
          $rdpService = Get-Service -Name TermService
          if ($rdpService.Status -ne 'Running') {
              Write-Host "Starting RDP service..."
              Start-Service -Name TermService
              Start-Sleep -Seconds 3
          }
          
          # Test local RDP port
          Write-Host "Testing local RDP port..."
          $localTest = Test-NetConnection -ComputerName localhost -Port 3389 -WarningAction SilentlyContinue
          if ($localTest.TcpTestSucceeded) {
              Write-Host "✓ Local RDP port is accessible"
          } else {
              Write-Warning "Local RDP port test failed"
          }
          
          # Test Tailscale IP connectivity
          if ($env:TAILSCALE_IP) {
              Write-Host "Testing Tailscale IP connectivity..."
              $tsTest = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
              if ($tsTest.TcpTestSucceeded) {
                  Write-Host "✓ RDP is accessible via Tailscale"
              } else {
                  Write-Warning "Tailscale RDP test failed (this may be normal due to network isolation)"
              }
          }
          
          # Display network configuration
          Write-Host "`nNetwork Configuration:"
          ipconfig | Select-String -Pattern "IPv4|Tailscale"

      - name: Maintain Connection
        run: |
          # Set password variable if not set
          if (-not $env:RDP_PASSWORD) {
              $env:RDP_PASSWORD = "M3hr@z!2024#Secure"
          }
          
          Write-Host "`n" 
          Write-Host "============================================"
          Write-Host "           RDP CONNECTION READY             "
          Write-Host "============================================"
          Write-Host ""
          Write-Host "  Tailscale IP : $env:TAILSCALE_IP"
          Write-Host "  Username     : mehraz"
          Write-Host "  Password     : M3hr@z!2024#Secure"
          Write-Host ""
          Write-Host "  Connect using Remote Desktop Client:"
          Write-Host "  mstsc /v:$env:TAILSCALE_IP"
          Write-Host ""
          Write-Host "============================================"
          Write-Host ""
          Write-Host "Note: Make sure you're connected to the same"
          Write-Host "      Tailscale network to access this machine"
          Write-Host ""
          Write-Host "Press Ctrl+C in GitHub Actions to terminate"
          Write-Host ""
          
          # Keep the runner active
          $startTime = Get-Date
          while ($true) {
              $elapsed = (Get-Date) - $startTime
              $hours = [math]::Floor($elapsed.TotalHours)
              $minutes = $elapsed.Minutes
              $seconds = $elapsed.Seconds
              
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Session Active: $($hours)h $($minutes)m $($seconds)s - Connection available at $env:TAILSCALE_IP"
              
              # Check if RDP service is still running
              $rdpStatus = Get-Service -Name TermService -ErrorAction SilentlyContinue
              if ($rdpStatus.Status -ne 'Running') {
                  Write-Warning "RDP service stopped, attempting restart..."
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
              }
              
              Start-Sleep -Seconds 300
          }
